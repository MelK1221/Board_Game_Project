{% extends "base.html" %}

{% block head %}
{{ super() }}
{% endblock %}

{% block title %}Games{% endblock %}

{% block content %}

<h1>Games</h1>

<table id="games" class="display" style="width:100%">
    <thead>
        <tr>
            <th class="all"></th>
            <th class="all">Game</th>
            <th class="all">Actions</th>
        </tr>
    </thead>
</table>


<script>

$(document).keypress(function(e) {
    if (e.keycode == 13 || e.which == 13) {
        // no buttons expect for positive buttons on modal
        // have ids: ui primary positive button
        $('.ui.primary.positive.button').click();
    }
});

$(document).ready(function() {

    let games_table = $('#games').DataTable({
        "lengthMenu": [[10, 25, 50, -1], [10, 25, 50, "All"]],
        "iDisplayLength": -1,
        "ajax": {
            "url": "{{ request.url_for('get_games') }}",
            "dataSrc": function(json) {
                // Convert {GameName: [ratings]} â†’ array of objects
                return Object.entries(json).map(([name, ratings]) => {
                    return { game: name, ratings: ratings };
                });
            }
        },
        "columns": [
            {
                "data": "game",
                "title": "Game",
                "width": "60%",
            },
            {
                "data": "ratings",
                "title": "Average Rating",
                "width": "30%",
                "render": function(data, type, row) {
                    if (!data || data.length === 0) return "N/A";
                    let avg = data.reduce((a, b) => a + b, 0) / data.length;
                    return avg.toFixed(2);
                }
            },
            {
                "width": "10%",
                "class": "dt-body-left dimmable",
                "render": function(data, type, row) {
                    let res = "";
                    // FIXME: replace with magnifying glass - place holder for info
                    res += "<div class='mini ui icon button test-button' data-tooltip='Test tooltip'><i class='terminal icon'></i></div>";
                    return res
                }
            }
        ],
        "order": [[1, "desc"]],
    });

    function register_button_callbacks() {
        let entry = $('#games tbody');

        _entry.on('click', '.test-button', function () {
            let data = games_table.row($(this).parents('tr')).data();
            // TODO: do something
        });
    }

    register_button_callbacks();

})

</script>

{% endblock %}